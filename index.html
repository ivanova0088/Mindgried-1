<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MindGrid – شبكة العقول</title>
  <meta name="theme-color" content="#0891b2"/>
  <link rel="manifest" href="manifest.json"><!-- اختياري الآن -->
  <style>
    :root{
      --bg1:#e7f3ff; --bg2:#ffffff; --fg:#0a0f14; --muted:#586174; --card:#ffffff; --line:#d9e4ef;
      --brand:#0891b2; --accent:#0ea5e9; --good:#10b981; --warn:#f97316; --bad:#ef4444;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg1:#0b1b2a; --bg2:#00121d; --fg:#e7eef7; --muted:#a6b3c4; --card:#0e2233; --line:#13354a;
        --brand:#38bdf8; --accent:#22d3ee; --good:#34d399; --warn:#fb923c; --bad:#f87171;
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Naskh Arabic UI','Noto Sans Arabic',Tahoma,Arial,sans-serif;
      color:var(--fg);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100svh;
    }
    header{
      display:flex; align-items:center; gap:12px; padding:16px 18px; border-bottom:1px solid var(--line);
      backdrop-filter:saturate(1.2) blur(6px);
    }
    .logo{width:40px;height:40px;border-radius:10px;background:radial-gradient(circle at 30% 30%, var(--accent), var(--brand));}
    h1{font-size:18px; margin:0}
    .sub{font-size:12px; opacity:.8; margin-top:2px}
    .coins{margin-inline-start:auto; padding:8px 12px; border:1px solid var(--line); background:var(--card); border-radius:999px; font-weight:700}
    main{max-width:820px; margin:auto; padding:18px}
    .grid{display:grid; grid-template-columns:1fr; gap:14px}
    @media (min-width:560px){ .grid{grid-template-columns:1fr 1fr} }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 8px 24px rgba(2,6,23,.06);
    }
    .card h2{margin:0 0 8px 0; font-size:16px}
    .btn{display:inline-block; padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:var(--bg2); color:var(--fg); font-weight:700; cursor:pointer}
    .btn.brand{background:var(--brand); color:white; border-color:transparent}
    .btn.ghost{background:transparent}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .hint{font-size:12px; color:var(--muted)}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .hidden{display:none}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; border:1px solid var(--line); font-size:12px}
    .list{display:grid; gap:10px}
    .item{padding:12px;border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.08),transparent)}
    input[type="text"]{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:var(--bg2); color:var(--fg)}
    .success{color:var(--good)} .warn{color:var(--warn)} .danger{color:var(--bad)}
    footer{opacity:.6; text-align:center; padding:24px 12px; font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>MindGrid – شبكة العقول</h1>
      <div class="sub">كلمات متقاطعة وألغاز يومية</div>
    </div>
    <div id="coins" class="coins">🪙 0</div>
  </header>

  <main>
    <!-- الصفحة الرئيسية -->
    <section id="home" class="grid">
      <div class="card">
        <h2>🧩 ألغاز اليوم</h2>
        <div class="hint">5 ألغاز متجددة يوميًا • تلميحات • مكافآت</div>
        <div class="sep"></div>
        <div class="row">
          <button class="btn brand" onclick="nav('daily')">ابدأ الآن</button>
          <button class="btn ghost" onclick="showHow()">طريقة اللعب</button>
        </div>
      </div>
      <div class="card">
        <h2>🏆 التحديات المباشرة</h2>
        <div class="hint">واجهة تجريبية ضد خصم وهمي • +50 عملة للفوز</div>
        <div class="sep"></div>
        <button class="btn" onclick="nav('versus')">ابدأ التحدي</button>
      </div>
      <div class="card">
        <h2>🛍 المتجر</h2>
        <div class="hint">اشترِ تلميحات (10) أو تخطي (25)</div>
        <div class="sep"></div>
        <button class="btn" onclick="nav('store')">افتح المتجر</button>
      </div>
      <div class="card">
        <h2>🔥 الستريك (الأيام المتتالية)</h2>
        <div id="streakBox" class="pill">0 يوم</div>
        <div class="hint" id="streakHint">ادخل كل يوم لتحافظ على الستريك. ينكسر بعد 24 ساعة.</div>
      </div>
    </section>

    <!-- ألغاز اليوم -->
    <section id="daily" class="hidden">
      <div class="row" style="margin-bottom:12px">
        <button class="btn" onclick="nav('home')">⬅ رجوع</button>
        <div class="pill">🪙 <span id="coins2">0</span></div>
      </div>
      <div class="list" id="puzzles"></div>
    </section>

    <!-- التحديات المباشرة -->
    <section id="versus" class="hidden">
      <div class="row" style="margin-bottom:12px">
        <button class="btn" onclick="nav('home')">⬅ رجوع</button>
        <div class="pill">🪙 <span id="coins3">0</span></div>
      </div>
      <div class="card">
        <h2>🏁 تحدّي سريع</h2>
        <div class="hint">سيظهر نفس السؤال لك و«خصم وهمي». إن أجبت أسرع تفوز +50 🪙</div>
        <div class="sep"></div>
        <div id="versusArea">
          <div class="item">
            <div id="vq" style="margin-bottom:8px;font-weight:700"></div>
            <input id="va" type="text" placeholder="أدخل الإجابة هنا"/>
            <div class="row" style="margin-top:8px">
              <button class="btn brand" onclick="submitVersus()">تحقق</button>
              <button class="btn" onclick="newVersus()">تحدّي جديد</button>
            </div>
            <div id="vstatus" class="hint" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- المتجر -->
    <section id="store" class="hidden">
      <div class="row" style="margin-bottom:12px">
        <button class="btn" onclick="nav('home')">⬅ رجوع</button>
        <div class="pill">🪙 <span id="coins4">0</span></div>
      </div>
      <div class="list">
        <div class="item">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><b>تلميح فوري</b><div class="hint">يظهر حرف/كلمة مساعدة • التكلفة 10</div></div>
            <button class="btn" onclick="buy('hint')">شراء 10🪙</button>
          </div>
        </div>
        <div class="item">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><b>تخطي لغز</b><div class="hint">تعتبره محلولاً • التكلفة 25</div></div>
            <button class="btn" onclick="buy('skip')">شراء 25🪙</button>
          </div>
        </div>
        <div class="item">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><b>باقة دعم MindGrid</b><div class="hint">+200 عملة للمساعدة في التطوير</div></div>
            <button class="btn" onclick="grant(200)">دعم +200🪙</button>
          </div>
        </div>
      </div>
    </section>

    <!-- طريقة اللعب -->
    <section id="how" class="hidden">
      <div class="row" style="margin-bottom:12px">
        <button class="btn" onclick="nav('home')">⬅ رجوع</button>
      </div>
      <div class="card">
        <h2>طريقة اللعب</h2>
        <div class="list">
          <div class="item">🎯 لديك 5 ألغاز يوميًا. كل حل صحيح يعطيك عملات.</div>
          <div class="item">💡 تستطيع أخذ تلميح (−10🪙) أو تخطي لغز (−25🪙).</div>
          <div class="item">🔥 الستريك: ادخل كل يوم لتحصل على مكافآت تصاعدية. ينكسر بعد 24 ساعة.</div>
          <div class="item">🏆 التحدّي: أجب أسرع من الخصم الوهمي لتحصل على +50🪙.</div>
        </div>
      </div>
    </section>
  </main>

  <footer>نسخة تجريبية قريبة من النهائية – MindGrid</footer>

  <script>
  // ====== تخزين محلي ======
  const S = {
    coins: 'mg_coins',
    streak: 'mg_streak',
    dayKey: 'mg_day',
    solved: 'mg_solved',
    inventory: 'mg_inv'
  };

  const todayKey = () => new Date().toISOString().slice(0,10);

  function getCoins(){ return +(localStorage.getItem(S.coins) || 100); }
  function setCoins(v){ localStorage.setItem(S.coins, v); syncCoins(); }
  function syncCoins(){
    const c = getCoins();
    ['coins','coins2','coins3','coins4'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.textContent = c;
    });
  }

  // ستريك صارم 24 ساعة
  function updateStreak(){
    let st = JSON.parse(localStorage.getItem(S.streak) || '{"count":0,"last":""}');
    const last = st.last ? new Date(st.last) : null;
    const now = new Date();
    const lastKey = st.last?.slice(0,10);
    const tKey = todayKey();
    if(!last){
      st = {count:1, last: now.toISOString()};
      rewardStreak(st.count);
    }else{
      if(lastKey === tKey){
        // نفس اليوم: لا شيء
      }else{
        const diff = Math.floor((now - new Date(tKey+"T00:00:00Z"))/86400000) -
                     Math.floor((new Date(st.last.slice(0,10)+"T00:00:00Z") - new Date(tKey+"T00:00:00Z"))/86400000);
        // حساب بسيط: هل اليوم التالي؟ (فرق يوم)
        const lastDay = new Date(st.last.slice(0,10));
        const d = Math.round((new Date(tKey) - lastDay) / 86400000);
        if(d === 1){
          st.count += 1;
          rewardStreak(st.count);
        }else if(d >= 2){
          st.count = 1;
          rewardStreak(st.count);
        }
      }
      st.last = now.toISOString();
    }
    localStorage.setItem(S.streak, JSON.stringify(st));
    renderStreak();
  }

  function rewardStreak(n){
    // +5 تصاعديًا حتى 50، واليوم 7 تلميح مجاني (نحوّله +10 عملة مكافأة)
    const base = Math.min(5*n, 50);
    setCoins(getCoins() + base + (n===7 ? 10 : 0));
  }

  function renderStreak(){
    const st = JSON.parse(localStorage.getItem(S.streak) || '{"count":0,"last":""}');
    const el = document.getElementById('streakBox');
    if(el) el.textContent = st.count + ' يوم';
  }

  // جلب/توليد ألغاز اليوم (ثابتة محليًا للنسخة التجريبية)
  function getTodayPuzzles(){
    const key = 'mg_puzzles_'+todayKey();
    const cached = localStorage.getItem(key);
    if(cached) return JSON.parse(cached);
    // خمسة ألغاز متنوعة (متوسطة الصعوبة)
    const puzzles = [
      {id:'p1', type:'text', q:'مدينة عربية: عاصمة ذات سور تاريخي، أشهر معالمها القلعة (6 حروف).', a:'حلب', reward:20, hint:'تقع في سوريا.'},
      {id:'p2', type:'text', q:'شيء إذا تكلمتَ به كسرته.', a:'الصمت', reward:20, hint:'عكس الضجيج.'},
      {id:'p3', type:'text', q:'كاتب عالمي: صاحب "الجريمة والعقاب" (اسم العائلة).', a:'دوستويفسكي', reward:25, hint:'روائي روسي.'},
      {id:'p4', type:'text', q:'كلمة من 4 حروف: ماء متجمد.', a:'ثلج', reward:15, hint:'أبيض..'},
      {id:'p5', type:'text', q:'مدينة عربية على الخليج، اسمها من 5 حروف.', a:'الدوحة', reward:20, hint:'تستضيف فعاليات رياضية كبيرة.'},
    ];
    localStorage.setItem(key, JSON.stringify(puzzles));
    return puzzles;
  }

  function renderPuzzles(){
    const box = document.getElementById('puzzles');
    box.innerHTML = '';
    const solvedKey = S.solved + '_' + todayKey();
    const solved = JSON.parse(localStorage.getItem(solvedKey) || '[]');
    getTodayPuzzles().forEach(p=>{
      const wrap = document.createElement('div'); wrap.className = 'item';
      const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = 'لغز: ' + p.q;
      const input = document.createElement('input'); input.type='text'; input.placeholder = 'أدخل الإجابة هنا';
      const status = document.createElement('div'); status.className='hint'; status.style.marginTop='8px';
      const row = document.createElement('div'); row.className='row'; row.style.marginTop='8px';
      const btnCheck = document.createElement('button'); btnCheck.className='btn brand'; btnCheck.textContent='تحقق';
      const btnHint = document.createElement('button'); btnHint.className='btn'; btnHint.textContent='تلميح (10🪙)';
      const btnSkip = document.createElement('button'); btnSkip.className='btn'; btnSkip.textContent='تخطي (25🪙)';

      // حالة محلول
      if(solved.includes(p.id)){
        status.innerHTML = '✅ محلول • +'+p.reward+'🪙';
        input.disabled = true; btnCheck.disabled = btnHint.disabled = btnSkip.disabled = true;
      }

      btnCheck.onclick = ()=>{
        const ans = (input.value || '').trim();
        if(!ans){ status.textContent='اكتب إجابتك أولاً.'; return; }
        if(normalize(ans) === normalize(p.a)){
          if(!solved.includes(p.id)){
            setCoins(getCoins() + p.reward);
            solved.push(p.id);
            localStorage.setItem(solvedKey, JSON.stringify(solved));
          }
          status.innerHTML = '<span class="success">إجابة صحيحة! +'+p.reward+'🪙</span>';
          input.disabled = true; btnCheck.disabled = btnHint.disabled = btnSkip.disabled = true;
          syncCoins();
        }else{
          status.innerHTML = '<span class="danger">ليست صحيحة.</span>';
        }
      };
      btnHint.onclick = ()=>{
        if(getCoins() < 10){ status.innerHTML = '<span class="warn">لا تملك عملات كافية للتلميح.</span>'; return; }
        setCoins(getCoins()-10);
        status.innerHTML = '💡 تلميح: '+p.hint;
      };
      btnSkip.onclick = ()=>{
        if(getCoins() < 25){ status.innerHTML = '<span class="warn">لا تملك عملات كافية للتخطي.</span>'; return; }
        if(!solved.includes(p.id)){
          setCoins(getCoins()-25);
          solved.push(p.id);
          localStorage.setItem(solvedKey, JSON.stringify(solved));
          status.innerHTML = '⏭ تم التخطي (−25🪙)';
          input.disabled = true; btnCheck.disabled = btnHint.disabled = btnSkip.disabled = true;
          syncCoins();
        }
      };

      row.append(btnCheck, btnHint, btnSkip);
      wrap.append(title, input, row, status);
      box.append(wrap);
    });
  }

  // تطبيع بسيط للمقارنة
  function normalize(s){ return s.toLowerCase().replace(/\s+/g,'').replace(/[اإآ]/g,'ا'); }

  // تنقّل
  function nav(id){
    ['home','daily','versus','store','how'].forEach(x=>{
      document.getElementById(x).classList.add('hidden');
    });
    document.getElementById(id).classList.remove('hidden');
    syncCoins();
    if(id==='daily') renderPuzzles();
    if(id==='versus') newVersus();
  }
  function showHow(){ nav('how'); }

  // المتجر
  function buy(what){
    if(what==='hint'){
      if(getCoins()<10) return alert('لا توجد عملات كافية.');
      setCoins(getCoins()-10);
      alert('تم شراء تلميح. استخدم زر التلميح داخل اللغز.');
    }else if(what==='skip'){
      if(getCoins()<25) return alert('لا توجد عملات كافية.');
      setCoins(getCoins()-25);
      alert('يمكنك الآن تخطي لغز واحد عبر زر التخطي.');
    }
  }
  function grant(n){ setCoins(getCoins()+n); alert('شكراً لدعمك! +'+n+'🪙'); }

  // التحدّي الوهمي
  let vCurrent = null, vOpponentTime = null, vStart = null;
  const VQS = [
    {q:'ما عاصمة المغرب؟', a:'الرباط'},
    {q:'مرادف: سريع (5 حروف).', a:'خاطف'},
    {q:'مجموع 17 + 28؟', a:'45'},
    {q:'كاتب "الخيميائي" (الاسم الأخير).', a:'كويلو'},
    {q:'بحر يفصل أوروبا عن أفريقيا؟', a:'المتوسط'}
  ];
  function newVersus(){
    vCurrent = VQS[Math.floor(Math.random()*VQS.length)];
    vOpponentTime = 3 + Math.floor(Math.random()*7); // ثواني
    vStart = Date.now();
    document.getElementById('vq').textContent = vCurrent.q;
    document.getElementById('va').value = '';
    document.getElementById('vstatus').textContent = 'ابدأ الآن…';
  }
  function submitVersus(){
    const sec = (Date.now()-vStart)/1000;
    const ans = (document.getElementById('va').value || '').trim();
    const ok = normalize(ans)===normalize(vCurrent.a);
    const st = document.getElementById('vstatus');
    if(!ok){ st.innerHTML = '<span class="danger">إجابة غير صحيحة.</span>'; return; }
    if(sec < vOpponentTime){
      setCoins(getCoins()+50);
      st.innerHTML = '<span class="success">فزت! كنت أسرع من الخصم. +50🪙</span>';
    }else{
      st.innerHTML = '<span class="warn">الخصم سبقك بثوانٍ قليلة. حاول مرة أخرى.</span>';
    }
    syncCoins();
  }

  // تهيئة
  function init(){
    if(!localStorage.getItem(S.coins)) setCoins(100);
    syncCoins();
    updateStreak();
    nav('home');
    // تسجيل عامل الخدمة لو الملف موجود لاحقًا
    if('serviceWorker' in navigator){
      fetch('sw.js',{method:'HEAD'}).then(r=>{
        if(r.ok) navigator.serviceWorker.register('sw.js');
      }).catch(()=>{});
    }
  }
  init();
  </script>
</body>
</html>
